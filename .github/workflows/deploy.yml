name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'adopt'
          java-version: '17'

      - name: Make application.yml
        run: |
          cd ./src/main/resources
          touch ./application.yml
          echo "${{ secrets.APPLICATION_YML }}" > ./application.yml

      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      - name: Docker login
        run: |
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker build & push
        run: |
          docker buildx create --use
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t ${{ secrets.DOCKER_REPO }}:latest \
            --push .

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            export DOCKER_REPO=${{ secrets.DOCKER_REPO }}

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
            sudo docker-compose down || true

            # ìµœì‹  ì´ë¯¸ì§€ pull
            sudo docker pull ${{ secrets.DOCKER_REPO }}:latest

            # docker-compose ì¬ì‹¤í–‰
            sudo docker-compose up -d

            # ì•ˆ ì“°ëŠ” ì´ë¯¸ì§€ ì‚­ì œ
            sudo docker image prune -f

#name: CI/CD Pipeline
#
#on:
#  push:
#    branches: [ main ]
#
#permissions:
#  contents: read
#
#jobs:
#  build:
#    runs-on: ubuntu-latest
#
#    steps:
#      # ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
#      - uses: actions/checkout@v3
#
#      # JDK 17 ì„¤ì •
#      - name: Set up JDK 17
#        uses: actions/setup-java@v3
#        with:
#          distribution: 'adopt'
#          java-version: '17'
#
#      # application.yml íŒŒì¼ ìƒì„±
#      - name: Make application.yml
#        run: |
#          cd ./src/main/resources
#          touch ./application.yml
#          echo "${{ secrets.APPLICATION_YML }}" > ./application.yml
#        shell: bash
#
#      # Gradleë¡œ ë¹Œë“œ
#      - name: Build with Gradle
#        run: |
#          chmod +x ./gradlew
#          ./gradlew clean build -x test
#
#      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (ğŸš¨ `--build-arg` ì¶”ê°€!)
##      - name: Docker build & push to Docker Hub
##        run: |
##          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
##          docker build --no-cache -t ${{ secrets.DOCKER_REPO }}:latest .
##          docker push ${{ secrets.DOCKER_REPO }}:latest ë‹¤ì‹œ
#      - name: Docker build & push to Docker Hub
#        run: |
#          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
#          docker buildx create --use
#          docker buildx build --platform linux/amd64,linux/arm64 \
#            -t ${{ secrets.DOCKER_REPO }}:latest \
#            --push .
#
#      # ì„œë²„ ë°°í¬
#      - name: Deploy to server with Docker
#        uses: appleboy/ssh-action@master
#        with:
#          host: ${{ secrets.EC2_HOST }}
#          username: ${{ secrets.EC2_USERNAME }}
#          key: ${{ secrets.EC2_SSH_KEY }}
#          script: |
#            sudo docker-compose down
#            sudo docker pull ${{ secrets.DOCKER_REPO }}:latest
#            sudo docker-compose -f docker-compose.yml up -d
#            sudo docker image prune -f
#      # jar íŒŒì¼ëª… í™•ì¸
#      - name: Show built files
#        run: |
#          ls -alh build/libs